#lang zuo

(require "harness.zuo")

(alert "build")

;; Test dependency cycle detection
(let ()
  (define p (process (hash-ref (runtime-env) 'exe #f)
                     (at-source "build-cycle.zuo")
                     (hash 'stdin 'pipe 'stdout 'pipe 'stderr 'pipe)))
  (fd-close (hash-ref p 'stdin))
  (define out (fd-read (hash-ref p 'stdout) eof))
  (define err (fd-read (hash-ref p 'stderr) eof))
  (fd-close (hash-ref p 'stdout))
  (fd-close (hash-ref p 'stderr))
  (process-wait (hash-ref p 'process))

  (check (glob-match? "*dependency cycle*" err) #t)
  (check "" out))

;; Test build timing output
(let ()
  (define p (process (hash-ref (runtime-env) 'exe #f)
                     (at-source "build-timing-test.zuo")
                     (hash 'stdin 'pipe 'stdout 'pipe 'stderr 'pipe)))
  (fd-close (hash-ref p 'stdin))
  (define out (fd-read (hash-ref p 'stdout) eof))
  (define err (fd-read (hash-ref p 'stderr) eof))
  (fd-close (hash-ref p 'stdout))
  (fd-close (hash-ref p 'stderr))
  (process-wait (hash-ref p 'process))

  ;; Should contain "building" and timing like "[0.001s]"
  (check (glob-match? "*building*" out) #t)
  (check (glob-match? "*[*s]*" out) #t))

;; Test quiet mode via hash option
(let ()
  (define p (process (hash-ref (runtime-env) 'exe #f)
                     (at-source "build-quiet-test.zuo")
                     (hash 'stdin 'pipe 'stdout 'pipe 'stderr 'pipe)))
  (fd-close (hash-ref p 'stdin))
  (define out (fd-read (hash-ref p 'stdout) eof))
  (define err (fd-read (hash-ref p 'stderr) eof))
  (fd-close (hash-ref p 'stdout))
  (fd-close (hash-ref p 'stderr))
  (process-wait (hash-ref p 'process))

  ;; Should contain "building" but NOT "echo"
  (check (glob-match? "*building*" out) #t)
  (check (glob-match? "*echo*" out) #f))

;; Test quiet mode via environment variable
(let ()
  (define env (hash-ref (runtime-env) 'env))
  (define p (process (hash-ref (runtime-env) 'exe #f)
                     (at-source "build-quiet-test.zuo")
                     (hash 'stdin 'pipe
                           'stdout 'pipe
                           'stderr 'pipe
                           'env (cons (cons "ZUO_BUILD_QUIET" "1") env))))
  (fd-close (hash-ref p 'stdin))
  (define out (fd-read (hash-ref p 'stdout) eof))
  (define err (fd-read (hash-ref p 'stderr) eof))
  (fd-close (hash-ref p 'stdout))
  (fd-close (hash-ref p 'stderr))
  (process-wait (hash-ref p 'process))

  ;; Should contain "building" but NOT "echo"
  (check (glob-match? "*building*" out) #t)
  (check (glob-match? "*echo*" out) #f))
